# MachineLearninGBox

MachineLearninGBox is a Monte Carlo simulation program of next generation of "smallbox" detector, abbreviated as SB.

SB is based on GEANT4.10.06.p02 Monte Carlo simulation package.

The purpose of SB is to use Monte Carlo simulation to verify the feasibility of using machine learning to reconstruct the particle position of single plastic scintillation detector.

# How to run

This is a classical cmake & build project, just

```shell
mkdir build
cd build
cmake ..
make -jN
```

Now you have finished compiling. If you want to simply run in interactive mode, just

```shell
./SBKernel -vis
```

Now you'll see the geometry of the detector. Please note that running in interactive mode is not the main way to use SB, but it is the most direct and intuitive. The main running mode of SB is batch mode, which will be introduced later.

After compiling, you will find that this produces three executable files SBKernel, SBRun, SBMerge and SBPost. Their functions are as follows.

- SBKernel

This is the kernel of SB program. Its usage is as follows:

```shell
SB [options]
    Options:
    -event [EventListFileName]
    -name [ROOTFileName]
    -seed [RandomSeed]
    -vis
```

If you don't use any flag, SB will run on batch mode. If you want to run in interactive mode, make sure you are using "-vis" flag.

If you would like to run on batch mode, please use "-event" flag to specify a event list. Where, [EventListFileName] is the name of the muon event list file. This file is a CSV file. For its format, see example_muon_event_list.csv in the datafiles folder. It passes muon's energy, target position and direction to SB. One line in this file represents one muon event that will be simulated. Please note that if "-event" flag is not used in batch mode, the run will not start. In interactive mode, it's OK to run with or without "-event" flag.

"-name" flag specifies the file name of the root file where the results will be saved. [ROOTFileName] is the file name you specify. There is no need to add the ".root" suffix. If you don't use this flag, the default "unnamed" will be used.

"-seed" flag specifies the seed of the random engine. If you don't use this flag, the internal default seed will be used.

It should be noted that SB uses G4RunManager instead of G4MTRunManager, which means that SB kernel itself can only be used for single-threaded computation. Parallel computing is implemented by multiple processes to achieve approximately linear speedup. For parallel computing, please see SBRun.

- SBRun

SBRun implements parallel computing by starting multiple SB kernel as child processes using fork and execl. After all SBKernels started, SBRun is waiting for them to exit. After all SBKernels exited, SBRun may call SBMerge and SBPost to merge root files and do some post-processing. At run time, multiple root files are generated by kernels, and you can choose whether to merge and process these files automatically at the end of the run. The usages of SBRun are as follows:

```shell
SBRun [MuonPropertyGridFileName] ([options])
    Options:
    -kernel [NumberOfKernels]
    -repeat [NumberOfRepetitions]
    -name [ROOTFileName]
    -seed [RandomSeedForFirstTask]
    -noautomerge
    -nopostprocessing
```

[MuonPropertyGridFileName] is the file name of event list CSV file. Please note that unlike event list which SBKernel uses, this event list do not list all events one by one, but define events as a "grid". Parameters in the grid will be combinated, and generate mutiple ture event list which will pass to SBKernel. The grid is a CSV file, after a run started, you can find them in runname/eventlist folder.

"-kernel" flag specifies the number of SBkernel will be started. If you don't use this flag, the maximum number of logical cores available for your computer will be used.

"-repeat" flag specifies how many times a run should be repeated, which means all events will be repeated by [NumberOfRepetitions] times. If you don't use this flag, all event will be processed only once.

"-name" flag specifies the file name of the root file where the results will be saved. [ROOTFileName] is the file name you specify. There is no need to add the ".root" suffix. If you don't use this flag, the default "unnamed" will be used.

"-seed" flag specify the seed that will be used by the first kernel, and the seed that will be used by next kernels is to add one to the seed that was used by the previous kernel. For example, if you specify that the first kernel uses seed 314159, the second kernel will use 314160, the third kernel will use 314161, and so on.

By default, after all SBKernel exits, SBRun will call SBMerge to merge all root files generated by kernels. If "-noautomerge" is used, root files will not be merged automatically.

By default, after all root files merged, SBRun will call SBPost to do post-processing. If "-nopostprocessing" is used, root files will not be processed automatically.

- SBMerge

SBMultiMerge merges multiple root files generated by multiple SB kernels. By default, SBRun will automatically call SBMultiMerge after all SB kernels exits.

Please note that using SBMultiMerge alone is not recommended. If you really need to use SBMultiMerge alone, please specify the file name, the total number of SB kernels, and the total number of events, carefully. These two numbers should be accurate, otherwise some strange things may happen.

